<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± ƒëo√°n T√†i X·ªâu ML - Web App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1e1e2f;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background-color: #2a2a44;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        h1, h2, h3 {
            color: #6a6aff;
            border-bottom: 2px solid #3c3c6e;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        /* Khu v·ª±c d√°n (ƒê√£ lo·∫°i b·ªè contenteditable ƒë·ªÉ tr√°nh b√†n ph√≠m ·∫£o) */
        #pasteArea {
            border: 3px dashed #6a6aff;
            min-height: 200px;
            text-align: center;
            line-height: 200px;
            font-size: 1.2em;
            cursor: pointer;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.3s;
            background-color: #3c3c6e;
            overflow: hidden; 
            /* Th√™m display: flex v√† cƒÉn gi·ªØa ƒë·ªÉ n·ªôi dung preview kh√¥ng b·ªã ·∫£nh h∆∞·ªüng */
            display: flex; 
            justify-content: center;
            align-items: center;
            line-height: normal; /* ƒê·∫∑t l·∫°i line-height */
            flex-direction: column; 
        }
        #pasteArea:hover {
            border-color: #9c9cff;
        }
        .image-preview {
            max-width: 90%;
            max-height: 180px;
            margin: 10px auto;
            border-radius: 6px;
        }
        .result-box {
            background-color: #1e1e2f;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .result-box p {
            margin: 5px 0;
        }
        .taixiu {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffcc00; 
        }
        .taixiu.T√†i {
            color: #00ff99; 
        }
        .taixiu.X·ªâu {
            color: #ff5555; 
        }
        /* Th√™m style cho th√¥ng b√°o d√°n/k√©o th·∫£ */
        #pasteText {
            margin: 10px;
            color: #ccc;
            font-size: 1em;
        }
        button {
            background-color: #6a6aff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #8c8cff;
        }
        input[type="number"] {
            padding: 8px;
            margin-right: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #3c3c6e;
            color: white;
            width: 80px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6a6aff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÆ D·ª± ƒëo√°n T√†i X·ªâu ML (Server API)</h1>
        
        <section id="prediction">
            <h2>1. D√°n/T·∫£i ·∫£nh (Mobile Ready)</h2>
            
            <input type="file" id="fileInput" accept="image/*" style="display: none;">

            <div id="pasteArea" onpaste="handlePaste(event)">
                <p id="pasteText">Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c D√°n ·∫£nh (Ctrl+V) / K√©o & Th·∫£.</p>
                <img id="imagePreview" class="image-preview" alt="Preview" style="display: none;">
            </div>
            
            <div id="previewContainer" style="display: none; text-align: center;">
                <p id="imageStatus"></p>
                <button onclick="startPrediction()" id="predictBtn">D·ª± ƒëo√°n Phi√™n Ti·∫øp theo (N)</button>
            </div>
            
            <div id="predictionResult" class="result-box" style="display: none;">
                <h3>K·∫øt qu·∫£ D·ª± ƒëo√°n Phi√™n N</h3>
                
                <p style="display: none;"><strong>Phi√™n tr∆∞·ªõc (N-2):</strong> <span id="dicePrev"></span></p>
                <p style="display: none;"><strong>Phi√™n hi·ªán t·∫°i (N-1):</strong> <span id="diceCurr"></span></p>
                <p style="display: none;"><strong>Delta:</strong> <span id="deltas"></span></p>
                <hr style="border-color: #3c3c6e; display: none;"> 
                
                <p><strong>T·ªïng ƒêi·ªÉm D·ª± ƒëo√°n:</strong> <span id="predictedTotal"></span></p>
                <p><strong>D·ª± ƒëo√°n:</strong> <span id="predictedResult" class="taixiu"></span></p>
            </div>
            <div id="loadingSpinner" class="loading-spinner"></div>
            <p id="messageArea" class="error"></p>
        </section>

        <section id="update" style="margin-top: 40px;">
            <h2>2. C·∫≠p nh·∫≠t M√¥ h√¨nh (Hu·∫•n luy·ªán)</h2>
            <p id="updateStatus">Vui l√≤ng ho√†n t·∫•t d·ª± ƒëo√°n tr∆∞·ªõc khi c·∫≠p nh·∫≠t.</p>
            
            <div id="updateForm" style="display: none;">
                <p style="color: #ffcc00;">X√°c nh·∫≠n T·ªïng ƒëi·ªÉm th·ª±c t·∫ø c·ªßa Phi√™n **V·ª™A QUA** (<span id="updateDiceCurr"></span>):</p>
                <input type="number" id="actualTotalInput" min="3" max="18" placeholder="Total N-1">
                <button onclick="updateModel()" id="updateBtn">C·∫≠p nh·∫≠t v√† T√°i hu·∫•n luy·ªán</button>
            </div>
        </section>
        
        <section id="statistics" style="margin-top: 40px;">
            <h2>3. Th·ªëng k√™ Hi·ªáu su·∫•t M√¥ h√¨nh</h2>
            <div class="result-box">
                <p>T·ªïng s·ªë phi√™n ƒë√£ hu·∫•n luy·ªán: <strong><span id="statsTotal">0</span></strong></p>
                <p style="color: #00ff99;">D·ª± ƒëo√°n ƒê√∫ng: <strong><span id="statsCorrect">0</span></strong></p>
                <p style="color: #ff5555;">D·ª± ƒëo√°n Sai: <strong><span id="statsIncorrect">0</span></strong></p>
                <hr style="border-color: #3c3c6e;">
                <p><strong>ƒê·ªô Ch√≠nh x√°c (Accuracy):</strong> <strong><span id="statsAccuracy">0%</span></strong></p>
            </div>
        </section>
    </div>

    <script>
        let imageBase64 = null;
        let predictionHistory = null;
        
        const fileInput = document.getElementById('fileInput'); // Th·∫ª input file ·∫©n
        const pasteArea = document.getElementById('pasteArea');
        const imagePreview = document.getElementById('imagePreview');
        const pasteText = document.getElementById('pasteText');
        const previewContainer = document.getElementById('previewContainer');
        const imageStatus = document.getElementById('imageStatus');
        const predictBtn = document.getElementById('predictBtn');
        const messageArea = document.getElementById('messageArea');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // --- H√†m Utilities ---
        function resetPreview() {
            imageBase64 = null;
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            pasteText.style.display = 'block';
            previewContainer.style.display = 'none';
            predictBtn.disabled = true;
        }

        function handleFileSelection(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imageBase64 = evt.target.result;
                    imagePreview.src = imageBase64;
                    imagePreview.style.display = 'block';
                    pasteText.style.display = 'none';
                    previewContainer.style.display = 'block';
                    predictBtn.disabled = false;
                    imageStatus.textContent = `·∫¢nh ƒë√£ s·∫µn s√†ng. Nh·∫•n "D·ª± ƒëo√°n".`;
                };
                reader.readAsDataURL(file);
            } else if (file) {
                alert("Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh.");
                resetPreview();
            }
        }
        
        // --- S·ª± ki·ªán click/tap tr√™n di ƒë·ªông ---
        pasteArea.addEventListener('click', () => {
            // K√≠ch ho·∫°t input file khi khu v·ª±c d√°n ƒë∆∞·ª£c click
            fileInput.click(); 
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });
        
        // --- S·ª± ki·ªán d√°n (Ctrl+V) tr√™n Desktop ---
        function handlePaste(event) {
            event.preventDefault(); 
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            let imageFound = false;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    handleFileSelection(blob);
                    imageFound = true;
                    break;
                }
            }

            if (!imageFound) {
                alert("Kh√¥ng t√¨m th·∫•y ·∫£nh trong clipboard.");
                resetPreview();
            }
        }

        // --- S·ª± ki·ªán K√©o/Th·∫£ (Desktop) ---
        pasteArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            pasteArea.style.borderColor = '#9c9cff';
        });

        pasteArea.addEventListener('dragleave', () => {
            pasteArea.style.borderColor = '#6a6aff';
        });

        pasteArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pasteArea.style.borderColor = '#6a6aff';
            
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });


        // G·ª≠i d·ª± ƒëo√°n l√™n Flask API (Gi·ªØ nguy√™n)
        async function startPrediction() {
            if (!imageBase64) return;

            predictBtn.disabled = true;
            messageArea.textContent = "";
            loadingSpinner.style.display = 'block';

            try {
                const response = await fetch("/api/predict", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ image: imageBase64 }),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    predictionHistory = data.history;
                    predictionHistory.predicted_result = data.prediction.result;
                    
                    document.getElementById('predictedTotal').textContent = data.prediction.total;
                    
                    const resultSpan = document.getElementById('predictedResult');
                    const result = data.prediction.result;

                    if (result === 'HOLD') {
                        resultSpan.textContent = "‚ö†Ô∏è R·ª¶I RO CAO: KH√îNG N√äN C∆Ø·ª¢C";
                        resultSpan.className = 'taixiu';
                        resultSpan.style.color = '#FFD700'; 
                    } else {
                        resultSpan.textContent = result;
                        resultSpan.className = 'taixiu ' + result;
                        resultSpan.style.color = ''; 
                    }

                    document.getElementById('predictionResult').style.display = 'block';
                    
                    // K√≠ch ho·∫°t khu v·ª±c c·∫≠p nh·∫≠t
                    document.getElementById('updateStatus').style.display = 'none';
                    document.getElementById('updateForm').style.display = 'block';
                    document.getElementById('updateDiceCurr').textContent = data.history.dice_curr.join('-');

                } else {
                    messageArea.textContent = `L·ªói D·ª± ƒëo√°n: ${data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`;
                    document.getElementById('predictionResult').style.display = 'none';
                    predictionHistory = null;
                }
            } catch (error) {
                messageArea.textContent = `L·ªói k·∫øt n·ªëi API: ${error.message}`;
            } finally {
                predictBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t m√¥ h√¨nh (Gi·ªØ nguy√™n)
        async function updateModel() {
            if (!predictionHistory) return;

            const actualTotal = parseInt(document.getElementById('actualTotalInput').value);

            if (isNaN(actualTotal) || actualTotal < 3 || actualTotal > 18) {
                alert("T·ªïng ƒëi·ªÉm th·ª±c t·∫ø ph·∫£i t·ª´ 3 ƒë·∫øn 18.");
                return;
            }

            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            messageArea.textContent = "";

            try {
                const response = await fetch("/api/update_model", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        features: predictionHistory.features,
                        actual_total: actualTotal,
                        dice_values_curr: predictionHistory.dice_curr,
                        predicted_result: predictionHistory.predicted_result
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    alert("‚úÖ " + data.message);
                    resetPreview(); // Reset giao di·ªán
                    document.getElementById('predictionResult').style.display = 'none';
                    document.getElementById('updateForm').style.display = 'none';
                    document.getElementById('updateStatus').style.display = 'block';
                    loadStats(); // T·∫£i l·∫°i th·ªëng k√™
                } else {
                    messageArea.textContent = `L·ªói C·∫≠p nh·∫≠t: ${data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`;
                }
            } catch (error) {
                messageArea.textContent = `L·ªói k·∫øt n·ªëi API: ${error.message}`;
            } finally {
                updateBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }
        
        // G·ªçi h√†m t·∫£i th·ªëng k√™ khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('pasteArea').addEventListener('paste', handlePaste);
            loadStats();
        });
        
        async function loadStats() {
            try {
                const response = await fetch("/api/stats");
                const data = await response.json();
                
                document.getElementById('statsTotal').textContent = data.total;
                document.getElementById('statsCorrect').textContent = data.correct;
                document.getElementById('statsIncorrect').textContent = data.incorrect;
                document.getElementById('statsAccuracy').textContent = `${data.accuracy}%`;
            } catch (error) {
                console.error("L·ªói t·∫£i th·ªëng k√™:", error);
            }
        }
    </script>
</body>
</html>