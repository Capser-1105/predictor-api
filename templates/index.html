<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± ƒëo√°n T√†i X·ªâu ML - Web App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1e1e2f;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background-color: #2a2a44;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        h1, h2, h3 {
            color: #6a6aff;
            border-bottom: 2px solid #3c3c6e;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        #pasteArea {
            border: 3px dashed #6a6aff;
            min-height: 200px;
            text-align: center;
            line-height: 200px;
            font-size: 1.2em;
            cursor: pointer;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.3s;
            background-color: #3c3c6e;
            overflow: hidden; /* ƒê·ªÉ ch·ª©a ·∫£nh d√°n */
        }
        #pasteArea:hover {
            border-color: #9c9cff;
        }
        .image-preview {
            max-width: 100%;
            max-height: 180px;
            margin-top: 10px;
            border-radius: 6px;
        }
        .result-box {
            background-color: #1e1e2f;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .result-box p {
            margin: 5px 0;
        }
        .taixiu {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffcc00; /* V√†ng */
        }
        .taixiu.T√†i {
            color: #00ff99; /* Xanh l√° */
        }
        .taixiu.X·ªâu {
            color: #ff5555; /* ƒê·ªè */
        }
        .error {
            color: #ff5555;
            font-weight: bold;
        }
        button {
            background-color: #6a6aff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #8c8cff;
        }
        input[type="number"] {
            padding: 8px;
            margin-right: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #3c3c6e;
            color: white;
            width: 80px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6a6aff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÆ D·ª± ƒëo√°n T√†i X·ªâu ML (S·ª≠ d·ª•ng Flask API)</h1>
        
        <section id="prediction">
            <h2>1. D√°n/T·∫£i ·∫£nh (Ctrl+V)</h2>
            <div id="pasteArea" contenteditable="true" 
                 onpaste="handlePaste(event)">
                D√°n ·∫£nh ch·ª•p x√≠ ng·∫ßu v√†o ƒë√¢y (Ctrl+V) ho·∫∑c K√©o/Th·∫£ file ·∫£nh.
            </div>
            
            <div id="previewContainer" style="display: none; text-align: center;">
                <img id="imagePreview" class="image-preview" alt="Preview">
                <p id="imageStatus"></p>
                <button onclick="startPrediction()" id="predictBtn">D·ª± ƒëo√°n Phi√™n Ti·∫øp theo (N)</button>
            </div>
            
            <div id="predictionResult" class="result-box" style="display: none;">
                <h3>K·∫øt qu·∫£ D·ª± ƒëo√°n Phi√™n N</h3>
                <p style="display: none;"><strong>Phi√™n tr∆∞·ªõc (N-2):</strong> <span id="dicePrev"></span></p>
                <p style="display: none;"><strong>Phi√™n hi·ªán t·∫°i (N-1):</strong> <span id="diceCurr"></span></p>
                <p style="display: none;"><strong>Delta:</strong> <span id="deltas"></span></p>
                <hr style="border-color: #3c3c6e; display: none;"> 
                <p><strong>T·ªïng ƒêi·ªÉm D·ª± ƒëo√°n:</strong> <span id="predictedTotal"></span></p>
                <p><strong>D·ª± ƒëo√°n:</strong> <span id="predictedResult" class="taixiu"></span></p>
            </div>
            <div id="loadingSpinner" class="loading-spinner"></div>
            <p id="messageArea" class="error"></p>
        </section>

        <section id="update" style="margin-top: 40px;">
            <h2>2. C·∫≠p nh·∫≠t M√¥ h√¨nh (Hu·∫•n luy·ªán)</h2>
            <p id="updateStatus">Vui l√≤ng ho√†n t·∫•t d·ª± ƒëo√°n tr∆∞·ªõc khi c·∫≠p nh·∫≠t.</p>
            
            <div id="updateForm" style="display: none;">
                <p style="color: #ffcc00;">X√°c nh·∫≠n T·ªïng ƒëi·ªÉm th·ª±c t·∫ø c·ªßa Phi√™n **V·ª™A QUA** (<span id="updateDiceCurr"></span>):</p>
                <input type="number" id="actualTotalInput" min="3" max="18" placeholder="Total N-1">
                <button onclick="updateModel()" id="updateBtn">C·∫≠p nh·∫≠t v√† T√°i hu·∫•n luy·ªán</button>
            </div>
        </section>
        
        <section id="statistics" style="margin-top: 40px;">
            <h2>3. Th·ªëng k√™ Hi·ªáu su·∫•t M√¥ h√¨nh</h2>
            <div class="result-box">
                <p>T·ªïng s·ªë phi√™n ƒë√£ hu·∫•n luy·ªán: <strong><span id="statsTotal">0</span></strong></p>
                <p style="color: #00ff99;">D·ª± ƒëo√°n ƒê√∫ng: <strong><span id="statsCorrect">0</span></strong></p>
                <p style="color: #ff5555;">D·ª± ƒëo√°n Sai: <strong><span id="statsIncorrect">0</span></strong></p>
                <hr style="border-color: #3c3c6e;">
                <p><strong>ƒê·ªô Ch√≠nh x√°c (Accuracy):</strong> <strong><span id="statsAccuracy">0%</span></strong></p>
            </div>
        </section>
    </div>

    <script>
        let imageBase64 = null;
        let predictionHistory = null;
        
        const pasteArea = document.getElementById('pasteArea');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const imageStatus = document.getElementById('imageStatus');
        const predictBtn = document.getElementById('predictBtn');
        const messageArea = document.getElementById('messageArea');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // H√†m t·∫£i th·ªëng k√™
        async function loadStats() {
            try {
                const response = await fetch("/api/stats");
                const data = await response.json();
                
                document.getElementById('statsTotal').textContent = data.total;
                document.getElementById('statsCorrect').textContent = data.correct;
                document.getElementById('statsIncorrect').textContent = data.incorrect;
                document.getElementById('statsAccuracy').textContent = `${data.accuracy}%`;
            } catch (error) {
                console.error("L·ªói t·∫£i th·ªëng k√™:", error);
            }
        }

        // --- X·ª≠ l√Ω s·ª± ki·ªán d√°n/k√©o th·∫£ ---
        pasteArea.addEventListener('click', () => {
            if (!imagePreview.src) pasteArea.innerHTML = ''; 
        });

        function handlePaste(event) {
            event.preventDefault(); 
            
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            let imageFound = false;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        imageBase64 = e.target.result;
                        imagePreview.src = imageBase64;
                        
                        pasteArea.innerHTML = ''; 
                        previewContainer.style.display = 'block';
                        imageStatus.textContent = '·∫¢nh ƒë√£ s·∫µn s√†ng. Nh·∫•n "D·ª± ƒëo√°n".';
                    };
                    reader.readAsDataURL(blob);
                    imageFound = true;
                    break;
                }
            }

            if (!imageFound) {
                pasteArea.innerHTML = 'Kh√¥ng t√¨m th·∫•y ·∫£nh trong clipboard. Vui l√≤ng th·ª≠ l·∫°i.';
                previewContainer.style.display = 'none';
            }
        }

        pasteArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            pasteArea.style.borderColor = '#9c9cff';
        });

        pasteArea.addEventListener('dragleave', () => {
            pasteArea.style.borderColor = '#6a6aff';
        });

        pasteArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pasteArea.style.borderColor = '#6a6aff';
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageBase64 = e.target.result;
                    imagePreview.src = imageBase64;
                    
                    pasteArea.innerHTML = ''; 
                    previewContainer.style.display = 'block';
                    imageStatus.textContent = `File ${file.name} ƒë√£ s·∫µn s√†ng. Nh·∫•n "D·ª± ƒëo√°n".`;
                };
                reader.readAsDataURL(file);
            } else {
                pasteArea.innerHTML = 'File kh√¥ng ph·∫£i l√† ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.';
            }
        });


        // G·ª≠i d·ª± ƒëo√°n l√™n Flask API
        async function startPrediction() {
            if (!imageBase64) {
                messageArea.textContent = "Vui l√≤ng d√°n ho·∫∑c t·∫£i ·∫£nh l√™n tr∆∞·ªõc.";
                return;
            }

            predictBtn.disabled = true;
            messageArea.textContent = "";
            loadingSpinner.style.display = 'block';

            try {
                const response = await fetch("/api/predict", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ image: imageBase64 }),
                });

                const data = await response.json();

                if (response.ok) {
                    predictionHistory = data.history;
                    predictionHistory.predicted_result = data.prediction.result;
                    
                    // ·∫®n c√°c d√≤ng chi ti·∫øt trong JS
                    document.getElementById('dicePrev').textContent = '';
                    document.getElementById('diceCurr').textContent = '';
                    document.getElementById('deltas').textContent = '';
                    
                    // Hi·ªÉn th·ªã T·ªïng ƒëi·ªÉm v√† D·ª± ƒëo√°n
                    document.getElementById('predictedTotal').textContent = data.prediction.total;
                    
                    const resultSpan = document.getElementById('predictedResult');
                    const result = data.prediction.result;

                    if (result === 'HOLD') {
                        resultSpan.textContent = "‚ö†Ô∏è R·ª¶I RO CAO: KH√îNG N√äN C∆Ø·ª¢C";
                        resultSpan.className = 'taixiu';
                        resultSpan.style.color = '#FFD700'; 
                    } else {
                        resultSpan.textContent = result;
                        resultSpan.className = 'taixiu ' + result;
                        resultSpan.style.color = '';
                    }

                    document.getElementById('predictionResult').style.display = 'block';
                    
                    // K√≠ch ho·∫°t khu v·ª±c c·∫≠p nh·∫≠t
                    document.getElementById('updateStatus').style.display = 'none';
                    document.getElementById('updateForm').style.display = 'block';
                    document.getElementById('updateDiceCurr').textContent = data.history.dice_curr.join('-');

                } else {
                    messageArea.textContent = `L·ªói D·ª± ƒëo√°n: ${data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`;
                    document.getElementById('predictionResult').style.display = 'none';
                    predictionHistory = null;
                }
            } catch (error) {
                messageArea.textContent = `L·ªói k·∫øt n·ªëi API: ${error.message}`;
                document.getElementById('predictionResult').style.display = 'none';
            } finally {
                predictBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t m√¥ h√¨nh
        async function updateModel() {
            if (!predictionHistory) {
                alert("Vui l√≤ng d·ª± ƒëo√°n m·ªôt phi√™n tr∆∞·ªõc.");
                return;
            }

            const actualTotal = parseInt(document.getElementById('actualTotalInput').value);

            if (isNaN(actualTotal) || actualTotal < 3 || actualTotal > 18) {
                alert("T·ªïng ƒëi·ªÉm th·ª±c t·∫ø ph·∫£i t·ª´ 3 ƒë·∫øn 18.");
                return;
            }

            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            messageArea.textContent = "";

            try {
                const response = await fetch("/api/update_model", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        features: predictionHistory.features,
                        actual_total: actualTotal,
                        dice_values_curr: predictionHistory.dice_curr,
                        predicted_result: predictionHistory.predicted_result
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    alert("‚úÖ " + data.message);
                    
                    // Reset giao di·ªán v√† bi·∫øn tr·∫°ng th√°i
                    predictionHistory = null;
                    imageBase64 = null;
                    document.getElementById('imagePreview').src = '';
                    document.getElementById('predictionResult').style.display = 'none';
                    document.getElementById('previewContainer').style.display = 'none';
                    document.getElementById('updateForm').style.display = 'none';
                    document.getElementById('updateStatus').style.display = 'block';

                    loadStats(); // T·∫£i l·∫°i th·ªëng k√™ sau khi c·∫≠p nh·∫≠t th√†nh c√¥ng
                } else {
                    messageArea.textContent = `L·ªói C·∫≠p nh·∫≠t: ${data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`;
                }
            } catch (error) {
                messageArea.textContent = `L·ªói k·∫øt n·ªëi API: ${error.message}`;
            } finally {
                updateBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }
        
        // G·ªçi h√†m t·∫£i th·ªëng k√™ khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>